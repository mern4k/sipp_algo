# SIPP: Safe Interval Path Planning - Реализация и модификации

Этот репозиторий содержит реализацию алгоритма SIPP и его bounded-suboptimal модификаций для планирования пути в окружениях с динамическими препятствиями, а также реализует генерацию случайных динамических препятствий и бенчмаркинг на ее основе.

## Описание

SIPP (Safe Interval Path Planning) - это алгоритм для поиска пути в пространстве с динамическими препятствиями, которые перемещаются по окружению. Алгоритм группирует последовательные моменты времени в безопасные интервалы и выполняет A* поиск в пространстве состояний, где каждое состояние представляет вершину в паре с безопасным временным интервалом.

В репозитории реализованы:
- **SIPP** - Оригинальный оптимальный алгоритм
- **Time A*** - Наивный подход с использованием пространственно-временного A*
- **Weighted SIPP (WSIPP)** - Использует взвешенную эвристику для более быстрых решений, не является complete 
- **WSIPP with Re-expansions (WSIPPr)** - За счет перераскрытий гарантированно находит путь при его существовании
- **WSIPP with Duplicate States (WSIPPd)** - Избегает переоткрытий путем дублирования состояний
- **Focal SIPP (FocalSIPP)** - Использует focal search с вторичной эвристикой для модификации базового **SIPP**

Bounded-suboptimal версии принимают параметр `w ≥ 1` и возвращают решения, стоимость которых не более чем в `w` раз превышает оптимальную стоимость, обменивая оптимальность на уменьшенное время вычислений.


## Информация об алгоритмах

| Алгоритм | Переоткрытия | Гарантии |
|----------|--------------|----------|
| SIPP | Нет | Optimal |
| Time A* | Нет | Optimal |
| WSIPP | Нет | Not Complete |
| WSIPPd | Нет | w-suboptimal | 
| WSIPPr | Да | w-suboptimal | 
| FocalSIPP | Да | w-suboptimal | 

## Структура проекта

```
.
├── utils/
│   ├── heuristics.py          # Эвристические функции (Манхэттенское расстояние)
│   ├── map.py                 # Представление карты и утилиты
│   ├── search_tree.py         # Классы вершин и структуры данных дерева поиска
│   ├── sipp.py                # Основная реализация SIPP
│   ├── wsipp.py               # Варианты Weighted SIPP
│   ├── focal_sipp.py          # Focal SIPP
│   ├── time_astar.py          # Базовый пространственно-временной A*
│   └── visualization.py       # Генерация анимаций
├── data/
│   ├── maps/                  # Файлы карт (формат .map)
│   ├── graphs/                # Графики сравнения метрик
│   ├── metrics/               # Сохраненные метрики
│   └── obstacles/             # Файлы динамических препятствий
├── samples/                   # Примеры входных файлов
├── out/                       # Выходная директория для анимаций
├── main.py                    # Простой запуск тестов
├── generate_map.py            # Генератор динамических препятствий
└── benchmarking.py            # Инструмент сравнения производительности
```

## Использование

### 1. Базовое тестирование (main.py)

Запуск предопределенных тестовых сценариев со всеми реализованными алгоритмами:

```bash
python main.py
```

**Параметры:**
- `test_index`: Выбор тестового сценария (0-4)
- `w`: Граница субоптимальности для взвешенных алгоритмов

**Выход:**
- Консоль: Статистика пути (время прибытия, шаги, созданные узлы, корректность)
- Файлы: Анимированные GIF в директории `out/`, показывающие движение агента и препятствий

### 2. Генерация динамических препятствий (generate_map.py)

Генерация случайных динамических препятствий для заданной карты:

```bash
python generate_map.py
```

**Параметры:**
- `map_name`: Имя файла карты (например, "arena")
- `max_obstacles`: Количество итераций генерации
- `p_continue`: Вероятность продолжения существующего пути препятствия

**Как это работает:**
1. Загружает карту из `data/maps/{map_name}.map`
2. Итеративно генерирует динамические препятствия:
   - С вероятностью `p_continue`: продолжает существующее препятствие, назначая новую случайную цель
   - Иначе: создает новое препятствие из случайных начала/цели
3. Сохраняет препятствия в `data/obstacles/dynamic_obstacles_{map_name}.txt`
4. Демонстрирует путь для агента с случаным началом и целью и создает визуализацию для сгенерированных динамических препятствий

**Выход:**
- Файл: `data/obstacles/dynamic_obstacles_{map_name}.txt`
- Консоль: Статистика генерации препятствий
- Анимация: `out/generated_dynamic_obstacles_{map_name}.gif`

### 3. Бенчмаркинг (benchmarking.py)

Сравнение алгоритмов на множестве тестовых случаев:

```bash
python benchmarking.py
```

**Параметры:**
- `map_name`: Файл карты для тестирования
- `recalc` (`True`/`False`): булев флаг, показывающий, нужно ли пересчитывать метрики, или же взять уже посчитанные
- `num_tasks`: Количество запусков для усреднения/отображения квартилей/медианы и т.д.
- `weights`: Список границ субоптимальности для тестирования

**Вычисляемые метрики:**
1. **Нормализованные раскрытия узлов**: Узлы, раскрытые каждым алгоритмом, нормализованные по раскрытиям в SIPP
2. **Качество решения**: Отношение стоимости пути к оптимальной стоимости пути
3. **SIPP против Time A***: Сравнение количеств раскрытых узлов

**Выход:** три графика сравнения вычисляемых метрик

## Форматы входных данных

### Файлы карт (формат .map)
[Стандартный формат movingai](https://movingai.com/benchmarks/formats.html)

### Файл динамических препятствий
```
obstacles <КОЛИЧЕСТВО>
obstacle <ID>
<ВРЕМЯ> <СТРОКА> <СТОЛБЕЦ>
<ВРЕМЯ> <СТРОКА> <СТОЛБЕЦ>
...
end
obstacle <ID>
...
```

**Формат:**
- Каждое препятствие - это последовательность позиций с временными метками
- `<ВРЕМЯ>` - Целочисленная временная метка
- `<СТРОКА>`, `<СТОЛБЕЦ>` - Координаты на сетке

**Пример:**
```
obstacles 2
obstacle 0
0 1 5
1 1 4
2 1 3
end
obstacle 1
0 2 8
1 2 7
end
```

### Файлы анимаций (GIF)
- Генерируются в директории `out/`
- Показывают агента (синий круг), перемещающегося вокруг динамических препятствий (цветные квадраты)
- Начальная позиция: зеленая
- Целевая позиция: красная
- Отображается текущее время симуляции

## Ссылки
Основано на статьях:
- [Phillips, M. and Likhachev, M., 2011. SIPP: Safe interval path planning for dynamic environments. In 2011 IEEE International Conference on Robotics and Automation, ICRA 2011  (pp. 5628-5635)](https://www.cs.cmu.edu/~maxim/files/sipp_icra11.pdf)
- [Yakovlev, K., Andreychuk, A. and Stern, R., 2020, June. Revisiting bounded-suboptimal safe interval path planning. In Proceedings of the 20th International Conference on Automated Planning and Scheduling, ICAPS 2020 (pp. 300-304)](https://ojs.aaai.org/index.php/ICAPS/article/download/6674/6528)
